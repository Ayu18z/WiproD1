<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Login</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="header">
    <img src="images/logo.png" class="logo">
    <span class="store-name">Pizzeria</span>
</header>


<div class="container">
    <h2 class="title">User Login</h2>

    <label for="email">Email</label>
    <input id="email" class="input" type="email" placeholder="you@example.com" required>

    <label for="password">Password</label>
    <input id="password" class="input" type="password" required>

    <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn" onclick="loginUser()">Login</button>
        <button class="back-btn" onclick="goBack()">Back</button>
    </div>

    <div style="margin-top:12px;">
        Don't have an account? <a href="register.html">Register here</a>
    </div>

    <div id="err" style="color:#b00020;margin-top:8px;display:none;"></div>
</div>
<div class="footer">
    © 2025 Pizza Ordering System — Fresh Hot Pizzas Everyday!
</div>
<script>
function showError(msg){
    const e = document.getElementById('err');
    e.style.display = 'block';
    e.textContent = msg;
}

function goBack(){
    if (history.length > 1) history.back();
    else window.location.href = '/';
}

function loginUser(){
    const emailOrUsername = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!emailOrUsername || !password) { showError("Fill email and password"); return; }

    const payload = {
        email: emailOrUsername,
        password: password
    };

    fetch("http://localhost:8081/user/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(async res => {
        if (!res.ok) {
            const txt = await res.text().catch(()=>res.statusText);
            throw new Error(txt || ("Login failed: " + res.status));
        }
        return res.json();
    })
    .then(result => {
        localStorage.setItem("token", result.token);
        localStorage.setItem("userId", result.userId);
        localStorage.setItem("username", result.username);
        localStorage.setItem("role", result.role || "USER"); 

        history.replaceState(null, "", location.href);

        window.location.href = "user-home.html";
    })
    .catch(err => {
        showError(err.message || "Invalid login");
    });
}
</script>
</body>
</html>
